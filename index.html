<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineMatch - Premium Movie Experience</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="theme-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&family=Bebas+Neue&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="page-loader">
        <div class="loader-content">
            <div class="loader-logo">CineMatch</div>
            <div class="loader-bar"></div>
        </div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-film"></i>
                <span>CineMatch</span>
            </div>
            <nav class="nav">
                <a href="#" class="nav-link active">Home</a>
                <a href="#recommendations" class="nav-link">Recommendations</a>
                <a href="watchlist.html" class="nav-link">Watchlist</a>
            </nav>
            <div class="header-actions">
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="Search movies...">
                    <i class="fas fa-search"></i>
                </div>
                <button class="profile-btn">
                    <i class="fas fa-user"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="main">
        <section class="hero">
            <div class="hero-bg"></div>
            <div class="hero-content">
                <div class="hero-info">
                    <h1 class="hero-title" id="hero-title">Discover Your Next Favorite Movie</h1>
                    <p class="hero-description" id="hero-description">Get personalized recommendations based on your mood, weather, and preferences. Experience cinema like never before.</p>
                    <div class="hero-actions">
                        <button class="btn-primary" id="hero-play">
                            <i class="fas fa-play"></i>
                            Watch Trailer
                        </button>
                        <button class="btn-secondary" id="hero-info">
                            <i class="fas fa-info-circle"></i>
                            More Info
                        </button>
                    </div>
                </div>
                <div class="hero-poster">
                    <img id="hero-poster-img" src="https://via.placeholder.com/400x600?text=Featured+Movie" alt="Featured Movie">
                </div>
            </div>
        </section>

        <section class="recommendations" id="recommendations">
            <div class="section-header">
                <h2>Personalized for You</h2>
            </div>
            
            <div class="recommendation-modes">
                <div class="mode-card" onclick="showWeatherRecommendations()">
                    <div class="mode-icon">üå§Ô∏è</div>
                    <h3>Weather-Based</h3>
                    <p>Perfect movies for your current weather</p>
                </div>
                <div class="mode-card" onclick="showMoodRecommendations()">
                    <div class="mode-icon">üé≠</div>
                    <h3>Mood Matching</h3>
                    <p>Movies that match your current vibe</p>
                </div>
                <div class="mode-card" onclick="showGenreRecommendations()">
                    <div class="mode-icon">üé™</div>
                    <h3>Genre Explorer</h3>
                    <p>Discover by your favorite genres</p>
                </div>
            </div>

            <div class="carousel-section">
                <h3 class="carousel-title">Trending Now</h3>
                <div class="loading-state" id="trending-loading">Loading movies...</div>
                <div class="movie-carousel" id="trending-carousel">
                    <div class="carousel-container">
                        <div class="movie-grid" id="trending-movies"></div>
                    </div>
                    <button class="carousel-btn prev" onclick="scrollCarousel('trending', -1)">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="carousel-btn next" onclick="scrollCarousel('trending', 1)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <div class="carousel-section">
                <h3 class="carousel-title">Popular Movies</h3>
                <div class="loading-state" id="popular-loading">Loading movies...</div>
                <div class="movie-carousel" id="popular-carousel">
                    <div class="carousel-container">
                        <div class="movie-grid" id="popular-movies"></div>
                    </div>
                    <button class="carousel-btn prev" onclick="scrollCarousel('popular', -1)">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="carousel-btn next" onclick="scrollCarousel('popular', 1)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </section>
    </main>

    <div class="movie-modal" id="movie-modal">
        <div class="modal-overlay" onclick="closeModal()"></div>
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-hero">
                <img id="modal-poster" src="" alt="Movie Poster">
                <div class="modal-info">
                    <h2 id="modal-title">Movie Title</h2>
                    <div class="modal-meta">
                        <span id="modal-rating">‚≠ê 8.5</span>
                        <span id="modal-year">2023</span>
                        <span id="modal-runtime">120 min</span>
                    </div>
                    <div class="modal-genres" id="modal-genres"></div>
                    <p id="modal-plot">Movie plot description...</p>
                    <div class="modal-actions">
                        <button class="btn-primary" id="modal-trailer">
                            <i class="fas fa-play"></i>
                            Watch Trailer
                        </button>
                        <button class="btn-secondary" id="modal-watchlist">
                            <i class="fas fa-plus"></i>
                            Add to Watchlist
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Frontend fetch function
        async function fetchOMDbMovies(keyword) {
            if (!keyword?.trim()) {
                throw new Error('Search keyword is required');
            }

            try {
                const response = await fetch(`/api/movies?query=${encodeURIComponent(keyword)}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch movies');
                }

                return data.movies;
            } catch (error) {
                console.error('Fetch error:', error);
                throw new Error(error.message || 'Network error occurred');
            }
        }

        // Main application
        class MovieApp {
            constructor() {
                this.currentMovie = null;
                this.watchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');
                this.init();
            }

            async init() {
                console.log('Initializing MovieApp...');
                this.showLoader();
                await this.loadAllMovies();
                this.setupEventListeners();
                this.hideLoader();
            }

            showLoader() {
                document.querySelector('.page-loader').style.display = 'flex';
            }

            hideLoader() {
                setTimeout(() => {
                    const loader = document.querySelector('.page-loader');
                    loader.style.opacity = '0';
                    setTimeout(() => loader.style.display = 'none', 500);
                }, 1000);
            }

            async loadAllMovies() {
                await Promise.all([
                    this.loadMovieSection('trending', 'action'),
                    this.loadMovieSection('popular', 'comedy'),
                    this.loadFeaturedMovie()
                ]);
            }

            async loadMovieSection(section, query) {
                const loadingEl = document.getElementById(`${section}-loading`);
                const containerEl = document.getElementById(`${section}-movies`);
                
                const queries = ['action', 'comedy', 'drama', 'thriller', 'romance', 'adventure'];
                const randomQuery = queries[Math.floor(Math.random() * queries.length)];
                
                try {
                    console.log(`Loading ${section} movies with query: ${randomQuery}`);
                    loadingEl.style.display = 'block';
                    
                    const movies = await fetchOMDbMovies(randomQuery);
                    
                    if (movies && movies.length > 0) {
                        this.displayMovies(containerEl, movies);
                        console.log(`${section} movies loaded:`, movies.length);
                    } else {
                        containerEl.innerHTML = '<div class="error-message">No movies found</div>';
                    }
                } catch (error) {
                    console.error(`Error loading ${section} movies:`, error);
                    containerEl.innerHTML = '<div class="error-message">Failed to load movies</div>';
                } finally {
                    loadingEl.style.display = 'none';
                }
            }

            async loadFeaturedMovie() {
                try {
                    const movies = await fetchOMDbMovies('batman');
                    if (movies && movies.length > 0) {
                        const movie = movies[0];
                        this.updateHeroSection(movie);
                        this.currentMovie = movie;
                    }
                } catch (error) {
                    console.error('Error loading featured movie:', error);
                    this.updateHeroSection({
                        title: 'CineMatch',
                        poster: 'https://via.placeholder.com/400x600?text=CineMatch'
                    });
                }
            }

            displayMovies(container, movies) {
                container.innerHTML = '';
                
                movies.forEach(movie => {
                    const movieCard = document.createElement('div');
                    movieCard.className = 'movie-card';
                    movieCard.innerHTML = `
                        <div class="movie-poster-wrapper">
                            <img src="${movie.poster || 'https://via.placeholder.com/200x300?text=No+Image'}" 
                                 alt="${movie.title}" 
                                 loading="lazy"
                                 onerror="this.src='https://via.placeholder.com/200x300?text=No+Image'">
                            <div class="movie-overlay">
                                <button class="play-trailer-btn" onclick="window.open('https://www.youtube.com/results?search_query=${movie.title}+trailer', '_blank')">
                                    <i class="fas fa-play"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    movieCard.addEventListener('click', () => this.showMovieModal(movie));
                    container.appendChild(movieCard);
                });
            }



            updateHeroSection(movie) {
                document.getElementById('hero-title').textContent = movie.title || 'Discover Your Next Favorite Movie';
                document.getElementById('hero-description').textContent = 'Get personalized recommendations based on your mood, weather, and preferences.';
                document.getElementById('hero-poster-img').src = movie.poster || 'https://via.placeholder.com/400x600?text=Featured+Movie';
            }

            showMovieModal(movie) {
                this.currentMovie = movie;
                
                document.getElementById('modal-poster').src = movie.poster || 'https://via.placeholder.com/250x375?text=No+Image';
                document.getElementById('modal-title').textContent = movie.title;
                document.getElementById('modal-year').textContent = movie.year;
                document.getElementById('modal-rating').textContent = '‚≠ê N/A';
                document.getElementById('modal-runtime').textContent = 'N/A';
                document.getElementById('modal-plot').textContent = 'Plot information not available.';
                
                const genresContainer = document.getElementById('modal-genres');
                genresContainer.innerHTML = '<span class="genre-tag">Movie</span>';
                
                const watchlistBtn = document.getElementById('modal-watchlist');
                const isInWatchlist = this.watchlist.some(item => item.imdbID === movie.imdbID);
                watchlistBtn.innerHTML = isInWatchlist 
                    ? '<i class="fas fa-check"></i> In Watchlist'
                    : '<i class="fas fa-plus"></i> Add to Watchlist';
                
                document.getElementById('movie-modal').classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            toggleWatchlist() {
                if (!this.currentMovie) return;
                
                const existingIndex = this.watchlist.findIndex(item => item.imdbID === this.currentMovie.imdbID);
                
                if (existingIndex > -1) {
                    this.watchlist.splice(existingIndex, 1);
                } else {
                    this.watchlist.push({
                        ...this.currentMovie,
                        addedAt: new Date().toISOString()
                    });
                }
                
                localStorage.setItem('watchlist', JSON.stringify(this.watchlist));
                
                const watchlistBtn = document.getElementById('modal-watchlist');
                const isInWatchlist = existingIndex === -1;
                watchlistBtn.innerHTML = isInWatchlist 
                    ? '<i class="fas fa-check"></i> In Watchlist'
                    : '<i class="fas fa-plus"></i> Add to Watchlist';
            }

            async handleSearch(query) {
                if (query.length < 3) return;
                
                try {
                    const movies = await fetchOMDbMovies(query);
                    this.displaySearchResults(movies);
                } catch (error) {
                    console.error('Search error:', error);
                }
            }

            displaySearchResults(movies) {
                let searchResults = document.getElementById('search-results');
                if (!searchResults) {
                    searchResults = document.createElement('div');
                    searchResults.id = 'search-results';
                    searchResults.className = 'search-results';
                    document.querySelector('.search-container').appendChild(searchResults);
                }
                
                if (movies.length === 0) {
                    searchResults.innerHTML = '<div class="no-results">No movies found</div>';
                    searchResults.classList.add('active');
                    return;
                }
                
                searchResults.innerHTML = movies.slice(0, 5).map(movie => `
                    <div class="search-item" onclick="app.showMovieModal(${JSON.stringify(movie).replace(/"/g, '&quot;')})">
                        <img src="${movie.poster || 'https://via.placeholder.com/50x75?text=No+Image'}" alt="${movie.title}">
                        <div class="search-info">
                            <div class="search-title">${movie.title}</div>
                            <div class="search-year">${movie.year}</div>
                        </div>
                    </div>
                `).join('');
                
                searchResults.classList.add('active');
            }

            hideSearchResults() {
                const searchResults = document.getElementById('search-results');
                if (searchResults) {
                    searchResults.classList.remove('active');
                }
            }

            setupEventListeners() {
                document.getElementById('search-input').addEventListener('input', (e) => this.handleSearch(e.target.value));
                document.getElementById('modal-watchlist').addEventListener('click', () => this.toggleWatchlist());
                document.getElementById('modal-trailer').addEventListener('click', () => {
                    if (this.currentMovie) {
                        window.open(`https://www.youtube.com/results?search_query=${this.currentMovie.title}+trailer`, '_blank');
                    }
                });
                document.getElementById('hero-play').addEventListener('click', () => {
                    if (this.currentMovie) {
                        window.open(`https://www.youtube.com/results?search_query=${this.currentMovie.title}+trailer`, '_blank');
                    }
                });
                
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.search-container')) {
                        this.hideSearchResults();
                    }
                });
            }
        }

        // Global functions
        function closeModal() {
            document.getElementById('movie-modal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function scrollCarousel(carouselId, direction) {
            const container = document.querySelector(`#${carouselId}-carousel .carousel-container`);
            if (container) {
                container.scrollBy({ left: 220 * direction, behavior: 'smooth' });
            }
        }

        function showWeatherRecommendations() {
            window.location.href = 'weather.html';
        }

        function showMoodRecommendations() {
            window.location.href = 'mood-weather.html';
        }

        function showGenreRecommendations() {
            window.location.href = 'genre.html';
        }

        // Initialize app
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new MovieApp();
        });
    </script>
</body>
</html>